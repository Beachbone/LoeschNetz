<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snapshots - LoeschNetz Admin</title>
    <link rel="stylesheet" href="./css/admin.css">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span>üî•</span>
                <span>Hydrantenplan Kappel-Kludenbach - Admin</span>
            </div>
            <div class="user-info">
                <span>Angemeldet als: <strong id="userName">...</strong></span>
                <span class="text-muted text-small" id="userRole"></span>
                <button id="changePasswordBtn" class="btn-header" title="Passwort √§ndern">üîê</button>
                <button class="btn-logout" id="logoutBtn">Abmelden</button>
            </div>
        </div>
    </div>

    <!-- Navigation (dynamically generated) -->
    <div id="nav-menu"></div>

    <!-- Container -->
    <div class="container">
        <!-- Message Container -->
        <div id="messageContainer"></div>

        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1>Snapshot-Verwaltung</h1>
                <p class="page-subtitle">Automatische Sicherungskopien deiner Hydrantendaten</p>
            </div>
            <button id="createSnapshotBtn" class="btn-primary">‚ûï Neuer Snapshot</button>
        </div>

        <!-- Info Cards -->
        <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-content">
                    <div class="stat-label">Gesamt</div>
                    <div class="stat-value" id="totalSnapshots">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíæ</div>
                <div class="stat-content">
                    <div class="stat-label">Gesamtgr√∂√üe</div>
                    <div class="stat-value" id="totalSize">0 KB</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚öôÔ∏è</div>
                <div class="stat-content">
                    <div class="stat-label">Max. Snapshots</div>
                    <div class="stat-value" id="maxSnapshotsInfo">20</div>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-info">
                <strong id="snapshotCount">0</strong> Snapshots
            </div>
            <button id="refreshSnapshotsBtn" class="btn-secondary">üîÑ Aktualisieren</button>
        </div>

        <!-- Mobile Sort Controls -->
        <div class="mobile-sort-controls">
            <label>Sortieren:</label>
            <select id="mobileSortField">
                <option value="date">Datum</option>
                <option value="hydrant_count">Hydranten</option>
                <option value="size_bytes">Gr√∂√üe</option>
                <option value="created_by">Erstellt von</option>
            </select>
            <button id="mobileSortToggle" title="Sortierreihenfolge umkehren">‚ÜïÔ∏è</button>
        </div>

        <!-- Snapshots Table -->
        <div class="table-container">
            <div id="snapshotsList" class="snapshots-list">
                <div class="loading">Lade Snapshots...</div>
            </div>
        </div>
    </div>
    <!-- /container -->

        <!-- Vorschau Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closePreview">√ó</button>
            <h2>üìã Snapshot-Vorschau</h2>
            <div id="previewContent">
                <div class="loading">Lade Vorschau...</div>
            </div>
        </div>
    </div>

    <!-- Restore Confirm Modal -->
    <div id="restoreModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeRestore">√ó</button>
            <h2>‚ö†Ô∏è Snapshot wiederherstellen</h2>
            <div class="warning-box">
                <p><strong>ACHTUNG:</strong> Diese Aktion √ºberschreibt ALLE aktuellen Hydranten!</p>
                <p>Es wird automatisch ein Backup des aktuellen Stands erstellt, bevor der Snapshot wiederhergestellt wird.</p>
            </div>
            <div id="restoreInfo"></div>
            <div class="modal-footer">
                <button id="confirmRestoreBtn" class="btn-danger">‚úÖ Ja, wiederherstellen</button>
                <button id="cancelRestoreBtn" class="btn-secondary">‚ùå Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeDelete">√ó</button>
            <h2>üóëÔ∏è Snapshot l√∂schen</h2>
            <p>M√∂chten Sie diesen Snapshot wirklich l√∂schen?</p>
            <div id="deleteInfo"></div>
            <div class="modal-footer">
                <button id="confirmDeleteBtn" class="btn-danger">‚úÖ Ja, l√∂schen</button>
                <button id="cancelDeleteBtn" class="btn-secondary">‚ùå Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Passwort-√Ñnderungs-Modal (wiederverwendet) -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="closeChangePassword">√ó</button>
            <h2>üîê Passwort √§ndern</h2>
            
            <div id="passwordChangeNotice" class="warning-box" style="display: none;">
                <p><strong>‚ö†Ô∏è Passwort-√Ñnderung erforderlich</strong></p>
                <p>Aus Sicherheitsgr√ºnden m√ºssen Sie Ihr Passwort √§ndern.</p>
            </div>
            
            <form id="changePasswordForm">
                <!-- Hidden username for accessibility -->
                <input type="text" name="username" autocomplete="username" style="display:none;" aria-hidden="true">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentPassword">Aktuelles Passwort *</label>
                        <input type="password" name="current_password" id="currentPassword" required autocomplete="current-password">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newPassword">Neues Passwort * <small>(mind. 8 Zeichen)</small></label>
                        <input type="password" name="new_password" id="newPassword" required minlength="8" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Passwort best√§tigen *</label>
                        <input type="password" name="confirm_password" id="confirmPassword" required minlength="8" autocomplete="new-password">
                    </div>
                    <div class="password-strength" id="passwordStrength"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">üíæ Passwort √§ndern</button>
                    <button type="button" id="cancelPasswordChange" class="btn-secondary">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./js/admin-utils.js"></script>
    <script src="./js/admin-auth.js"></script>
    <script src="./js/admin-menu.js"></script>
    <script src="./js/admin-password.js"></script>
    <script src="./js/admin-snapshots.js"></script>
    <script>
        // App initialisieren
        async function initApp() {
            // Session pr√ºfen
            const isLoggedIn = await Auth.checkSession();

            if (!isLoggedIn) {
                Auth.requireLogin();
                return;
            }

            // User-Info anzeigen
            Auth.displayUserInfo();

            // UI f√ºr Rolle anpassen
            Auth.updateUIForRole();

            // Menu generieren (nach Auth-Check!)
            AdminMenu.generate();
            
            // Event-Listener
            setupLogout();
            setupPasswordChange();

            // Snapshots initialisieren
            if (window.Snapshots) {
                Snapshots.init();
            }

            // Sorting setup
            setupDesktopSort();
            setupMobileSort();
        }
        
        // App starten wenn DOM bereit
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>

    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" aria-label="Nach oben" title="Nach oben">‚Üë</button>

    <script>
        (function() {
            const backToTopButton = document.getElementById('backToTop');
            const scrollThreshold = 300;

            function toggleBackToTopButton() {
                if (window.pageYOffset > scrollThreshold || document.documentElement.scrollTop > scrollThreshold) {
                    backToTopButton.classList.add('visible');
                } else {
                    backToTopButton.classList.remove('visible');
                }
            }

            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            window.addEventListener('scroll', toggleBackToTopButton);
            backToTopButton.addEventListener('click', scrollToTop);

            toggleBackToTopButton();
        })();
    </script>
</body>
</html>
