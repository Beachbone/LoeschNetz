<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Offline-f√§hige Hydrantenverwaltung f√ºr Feuerwehren">
    
    <title>LoeschNetz - Hydrantenverwaltung</title>
    
    <!-- PWA Manifest (dynamisch) -->
    <link rel="manifest" href="./manifest.php">
    
    <!-- Theme Color (wird aus config geladen) -->
    <meta name="theme-color" content="#d32f2f">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Favicons -->
    <link rel="icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <!-- PWA Meta-Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="LoeschNetz">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="LoeschNetz">
    
    <!-- Leaflet CSS (lokal gehostet) -->
    <link rel="stylesheet" href="./leaflet/leaflet.css">
    
    <!-- App CSS -->
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" class="cookie-banner" style="display: none;">
        <div class="cookie-content">
            <h3>üç™ Diese App nutzt Kartenmaterial</h3>
            <p>
                Um Hydranten anzuzeigen, l√§dt diese App Kartenmaterial von 
                <strong>OpenStreetMap.org</strong>. Dabei wird Ihre IP-Adresse √ºbertragen.
            </p>
            <p class="cookie-highlight">
                <strong>Es werden keine Tracking-Tools verwendet.</strong>
            </p>
            <div class="cookie-buttons">
                <button id="acceptCookies" class="btn-primary">Akzeptieren</button>
                <button id="declineCookies" class="btn-secondary">Ablehnen</button>
            </div>
            <a href="./datenschutz.html" class="cookie-link">Mehr erfahren</a>
        </div>
    </div>

    <!-- Cookie Declined Message -->
    <div id="cookieDeclined" class="cookie-declined" style="display: none;">
        <div class="declined-content">
            <h2>‚ö†Ô∏è App nicht verf√ºgbar</h2>
            <p>Ohne Zustimmung kann die App nicht genutzt werden.</p>
            <h3>App deinstallieren:</h3>
            <ul>
                <li><strong>Android:</strong> Einstellungen ‚Üí Apps ‚Üí LoeschNetz ‚Üí Deinstallieren</li>
                <li><strong>iOS:</strong> App gedr√ºckt halten ‚Üí "App entfernen"</li>
                <li><strong>Desktop:</strong> Adressleiste ‚Üí ‚ìò ‚Üí "LoeschNetz deinstallieren"</li>
            </ul>
            <button id="reconsiderCookies" class="btn-secondary">Erneut √ºberlegen</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>LoeschNetz wird geladen...</p>
        </div>
    </div>

    <!-- Offline Notice -->
    <div id="offlineNotice" class="offline-notice" style="display: none;">
        <span class="offline-icon">üì°</span>
        <span class="offline-text">Offline-Modus</span>
    </div>

    <!-- Main App Container -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">
                <img src="./icons/icon-48x48.png" class="logo" alt="LoeschNetz">
                <span id="appTitle">LoeschNetz</span>
            </h1>
            <button id="infoButton" class="icon-button" aria-label="Information">
                <span>‚ÑπÔ∏è</span>
            </button>
        </header>

        <!-- Map Container -->
        <div id="map" class="map-container"></div>

        <!-- Legend (ausklappbar, oben rechts) -->
        <div id="legend" class="legend collapsed">
            <button id="legendToggle" class="legend-toggle" aria-label="Legende umschalten">
                üìç Legende
            </button>
            <div id="legendContent" class="legend-content">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>

        <!-- GPS Location Button (unten rechts) -->
        <button id="gpsButton" class="gps-button" aria-label="Zu meinem Standort" title="Zu meinem Standort">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="3"/>
                <line x1="12" y1="1" x2="12" y2="5"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="1" y1="12" x2="5" y2="12"/>
                <line x1="19" y1="12" x2="23" y2="12"/>
            </svg>
        </button>

        <!-- Reload Button -->
        <button id="reloadButton" class="reload-button" aria-label="Daten neu laden" title="Daten neu laden">
            üîÑ
        </button>

        <!-- Footer (sticky) -->
        <footer class="app-footer">
            <a href="./impressum.html" target="_blank">Impressum</a>
            <span>|</span>
            <a href="./datenschutz.html" target="_blank">Datenschutz</a>
        </footer>

        <!-- Install Prompt (nur wenn noch nicht installiert) -->
        <div id="installPrompt" class="install-prompt" style="display: none;">
            <p>üì± LoeschNetz als App installieren?</p>
            <button id="installButton" class="btn-primary">Installieren</button>
            <button id="dismissInstall" class="btn-text">Sp√§ter</button>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" aria-label="Nach oben" title="Nach oben">‚Üë</button>

    <!-- Info Modal -->
    <div id="infoModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="infoModalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="closeInfo">√ó</button>
            <h2>‚ÑπÔ∏è √úber LoeschNetz</h2>
            <p>
                <strong>LoeschNetz</strong> ist eine Progressive Web App zur 
                Verwaltung und Anzeige von Feuerwehr-Hydranten.
            </p>
            <h3>Features:</h3>
            <ul>
                <li>‚úÖ Offline-f√§hige Kartenansicht</li>
                <li>‚úÖ Farbcodierte Hydranten</li>
                <li>‚úÖ Detailansicht mit Fotos</li>
                <li>‚úÖ Installierbar auf allen Ger√§ten</li>
                <li>‚úÖ GPS-Lokalisierung</li>
            </ul>
            <p class="version">Version 1.0.0 (Dezember 2025)</p>
            <div class="modal-links">
                <a href="./datenschutz.html">Datenschutz</a>
                <a href="./impressum.html">Impressum</a>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Leaflet.js (lokal gehostet) -->
    <script src="./leaflet/leaflet.js"></script>
    
    <!-- App Scripts -->
    <script src="./js/app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Service Worker registrieren
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registriert:', registration.scope);
                        
                        // Update-Check
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ Neue Version verf√ºgbar!');
                                    // User benachrichtigen
                                    if (confirm('Neue Version verf√ºgbar! Neu laden?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker Fehler:', error);
                    });
            });
            
            // Reload bei neuem SW
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Zeige Install-Button nach 10 Sekunden
            setTimeout(() => {
                const installPrompt = document.getElementById('installPrompt');
                if (installPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                    installPrompt.style.display = 'block';
                }
            }, 10000);
        });
        
        // Install-Button Handler
        document.getElementById('installButton')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Install outcome:', outcome);
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        });
        
        // Dismiss-Button Handler
        document.getElementById('dismissInstall')?.addEventListener('click', () => {
            document.getElementById('installPrompt').style.display = 'none';
        });
        
        // Online/Offline Status
        window.addEventListener('online', () => {
            document.getElementById('offlineNotice').style.display = 'none';
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offlineNotice').style.display = 'block';
        });
        
        // Initial Status
        if (!navigator.onLine) {
            document.getElementById('offlineNotice').style.display = 'block';
        }
    </script>

    <!-- Back to Top Button Functionality -->
    <script>
        (function() {
            const backToTopButton = document.getElementById('backToTop');
            const scrollThreshold = 300;

            function toggleBackToTopButton() {
                if (window.pageYOffset > scrollThreshold || document.documentElement.scrollTop > scrollThreshold) {
                    backToTopButton.classList.add('visible');
                } else {
                    backToTopButton.classList.remove('visible');
                }
            }

            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            window.addEventListener('scroll', toggleBackToTopButton);
            backToTopButton.addEventListener('click', scrollToTop);

            toggleBackToTopButton();
        })();
    </script>
</body>
</html>
