<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Offline-f√§hige Hydrantenverwaltung f√ºr Feuerwehren">
    
    <title>LoeschNetz - Hydrantenverwaltung</title>

    <link rel="manifest" href="/manifest.php">

    <meta name="theme-color" content="#d32f2f">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <link rel="icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="LoeschNetz">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="LoeschNetz">

    <link rel="stylesheet" href="./leaflet/leaflet.css">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" class="cookie-banner" style="display: none;">
        <div class="cookie-content">
            <h3>üç™ Diese App nutzt Kartenmaterial</h3>
            <p>
                Um Hydranten anzuzeigen, l√§dt diese App Kartenmaterial von 
                <strong>OpenStreetMap.org</strong>. Dabei wird Ihre IP-Adresse √ºbertragen.
            </p>
            <p class="cookie-highlight">
                <strong>Es werden keine Tracking-Tools verwendet.</strong>
            </p>
            <div class="cookie-buttons">
                <button id="acceptCookies" class="btn-primary">Akzeptieren</button>
                <button id="declineCookies" class="btn-secondary">Ablehnen</button>
            </div>
            <a href="./datenschutz.html" class="cookie-link">Mehr erfahren</a>
        </div>
    </div>

    <!-- Cookie Declined Message -->
    <div id="cookieDeclined" class="cookie-declined" style="display: none;">
        <div class="declined-content">
            <h2>‚ö†Ô∏è App nicht verf√ºgbar</h2>
            <p>Ohne Zustimmung kann die App nicht genutzt werden.</p>
            <h3>App deinstallieren:</h3>
            <ul>
                <li><strong>Android:</strong> Einstellungen ‚Üí Apps ‚Üí LoeschNetz ‚Üí Deinstallieren</li>
                <li><strong>iOS:</strong> App gedr√ºckt halten ‚Üí "App entfernen"</li>
                <li><strong>Desktop:</strong> Adressleiste ‚Üí ‚ìò ‚Üí "LoeschNetz deinstallieren"</li>
            </ul>
            <button id="reconsiderCookies" class="btn-secondary">Erneut √ºberlegen</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>LoeschNetz wird geladen...</p>
        </div>
    </div>

    <!-- Offline Notice -->
    <div id="offlineNotice" class="offline-notice" style="display: none;">
        <span class="offline-icon">üì°</span>
        <span class="offline-text">Offline-Modus</span>
    </div>

    <!-- Main App Container -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">
                <img src="./icons/icon-48x48.png" class="logo" alt="LoeschNetz">
                <span id="appTitle">LoeschNetz</span>
            </h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button id="installAppBtn" class="icon-button" title="App installieren" onclick="showInstallPrompt()" style="display: none;" aria-label="App installieren">
                    <span>üì±</span>
                </button>
                <button id="infoButton" class="icon-button" aria-label="Information">
                    <span>‚ÑπÔ∏è</span>
                </button>
            </div>
        </header>

        <!-- Map Container -->
        <div id="map" class="map-container"></div>

        <!-- Legend -->
        <div id="legend" class="legend collapsed">
            <button id="legendToggle" class="legend-toggle" aria-label="Legende umschalten">
                üìç Legende
            </button>
            <div id="legendContent" class="legend-content"></div>
        </div>

        <!-- GPS Location Button -->
        <button id="gpsButton" class="gps-button" aria-label="Zu meinem Standort" title="Zu meinem Standort">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="3"/>
                <line x1="12" y1="1" x2="12" y2="5"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="1" y1="12" x2="5" y2="12"/>
                <line x1="19" y1="12" x2="23" y2="12"/>
            </svg>
        </button>

        <button id="reloadButton" class="reload-button" aria-label="Daten neu laden" title="Daten neu laden" style="display: none;">
            üîÑ
        </button>

        <!-- Footer -->
        <footer class="app-footer">
            <a href="#" onclick="openImpressumModal(); return false;">Impressum</a>
            <span>|</span>
            <a href="#" onclick="openDatenschutzModal(); return false;">Datenschutz</a>
        </footer>

        <!-- Install Prompt -->
        <div id="installPrompt" class="install-prompt" style="display: none;">
            <p>LoeschNetz als App installieren?</p>
            <div class="install-actions">
                <button id="installButton">Installieren</button>
                <button id="dismissInstall">Sp√§ter</button>
            </div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTop" class="back-to-top" aria-label="Nach oben" title="Nach oben">‚Üë</button>

    <!-- Info Modal -->
    <div id="infoModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="infoModalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="closeInfo">√ó</button>
            <h2>‚ÑπÔ∏è √úber LoeschNetz</h2>
            <p>
                <strong>LoeschNetz</strong> ist eine Progressive Web App zur
                Verwaltung und Anzeige von Feuerwehr-Hydranten.
            </p>
            <h3>Features:</h3>
            <ul>
                <li>‚úÖ Offline-f√§hige Kartenansicht</li>
                <li>‚úÖ Farbcodierte Hydranten</li>
                <li>‚úÖ Detailansicht mit Fotos</li>
                <li>‚úÖ Installierbar auf allen Ger√§ten</li>
                <li>‚úÖ GPS-Lokalisierung</li>
            </ul>
            <p class="version">Version 1.0.0 (Dezember 2025)</p>

            <!-- Debug Information (nur wenn Debug-Modus aktiv) -->
            <div id="debugInfo" class="debug-info" style="display: none;">
                <h3>üêõ Debug-Informationen</h3>
                <div class="debug-grid">
                    <div class="debug-item">
                        <strong>Cache-Status:</strong>
                        <span id="debugCacheStatus">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Service Worker:</strong>
                        <span id="debugSWStatus">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Hydranten geladen:</strong>
                        <span id="debugHydrantCount">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Marker-Typen:</strong>
                        <span id="debugMarkerTypes">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Letzte Aktualisierung:</strong>
                        <span id="debugLastUpdate">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Browser:</strong>
                        <span id="debugBrowser">-</span>
                    </div>
                </div>

                <h4 style="margin-top: 16px;">‚ö° Performance-Metriken</h4>
                <div class="debug-grid">
                    <div class="debug-item">
                        <strong>App-Start:</strong>
                        <span id="debugLoadTime">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Config geladen:</strong>
                        <span id="debugConfigTime">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Daten geladen:</strong>
                        <span id="debugDataTime">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Karte initialisiert:</strong>
                        <span id="debugMapTime">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Gesamt-Ladezeit:</strong>
                        <span id="debugTotalTime">-</span>
                    </div>
                    <div class="debug-item">
                        <strong>Speicher:</strong>
                        <span id="debugMemory">-</span>
                    </div>
                </div>
            </div>

            <div class="modal-links">
                <a href="#" onclick="closeInfoModal(); openDatenschutzModal(); return false;">Datenschutz</a>
                <a href="#" onclick="closeInfoModal(); openImpressumModal(); return false;">Impressum</a>
            </div>
        </div>
    </div>

    <!-- Impressum Modal -->
    <div id="impressumModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="impressumModalOverlay"></div>
        <div class="modal-content legal-modal">
            <button class="modal-close" id="closeImpressum">√ó</button>
            <h2>Impressum</h2>

            <p><em>Hinweis: Diese Seite wird im Setup-Wizard automatisch generiert. Dies ist nur ein Platzhalter.</em></p>

            <h3>Angaben gem√§√ü ¬ß 5 TMG</h3>
            <p>
                [Wird im Setup eingef√ºgt]<br>
                [Adresse]<br>
                [Kontakt]
            </p>

            <h3>Vertreten durch</h3>
            <p>[Wird im Setup eingef√ºgt]</p>

            <h3>Kontakt</h3>
            <p>
                E-Mail: [Wird im Setup eingef√ºgt]<br>
                Telefon: [Wird im Setup eingef√ºgt]
            </p>

            <h3>Haftungsausschluss</h3>

            <h4>Haftung f√ºr Inhalte</h4>
            <p>
                Die Inhalte unserer Seiten wurden mit gr√∂√üter Sorgfalt erstellt.
                F√ºr die Richtigkeit, Vollst√§ndigkeit und Aktualit√§t der Inhalte
                k√∂nnen wir jedoch keine Gew√§hr √ºbernehmen.
            </p>

            <h4>Haftung f√ºr Links</h4>
            <p>
                Unser Angebot enth√§lt Links zu externen Webseiten Dritter, auf deren
                Inhalte wir keinen Einfluss haben. Deshalb k√∂nnen wir f√ºr diese
                fremden Inhalte auch keine Gew√§hr √ºbernehmen.
            </p>

            <p><small>Stand: November 2025</small></p>
        </div>
    </div>

    <!-- Datenschutz Modal -->
    <div id="datenschutzModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="datenschutzModalOverlay"></div>
        <div class="modal-content legal-modal">
            <button class="modal-close" id="closeDatenschutz">√ó</button>
            <h2>Datenschutzerkl√§rung</h2>

            <p><em>Hinweis: Diese Seite wird im Setup-Wizard automatisch generiert. Dies ist nur ein Platzhalter.</em></p>

            <h3>1. Verantwortlicher</h3>
            <p>
                [Wird im Setup eingef√ºgt]<br>
                [Adresse]<br>
                [Kontakt]
            </p>

            <h3>2. Datenverarbeitung</h3>

            <h4>Public App (ohne Login)</h4>
            <p><strong>Erhobene Daten:</strong> Keine personenbezogenen Daten</p>

            <p><strong>Externe Dienste:</strong></p>
            <ul>
                <li>OpenStreetMap.org (Karten-Tiles)</li>
                <li>Zweck: Kartendarstellung</li>
                <li>IP-√úbertragung: Ja (technisch notwendig)</li>
                <li>Rechtsgrundlage: Berechtigtes Interesse (Art. 6 Abs. 1 lit. f DSGVO)</li>
            </ul>

            <p><strong>Lokale Speicherung:</strong></p>
            <ul>
                <li>1 Cookie f√ºr DSGVO-Zustimmung (12 Monate)</li>
                <li>Service Worker Cache (Karten, Hydranten)</li>
                <li>L√∂schung: Durch Deinstallation der App</li>
            </ul>

            <h3>3. Keine Weitergabe an Dritte</h3>
            <p>Ihre Daten werden nicht an Dritte weitergegeben.</p>

            <h3>4. Ihre Rechte</h3>
            <ul>
                <li><strong>Auskunft</strong> (Art. 15 DSGVO)</li>
                <li><strong>L√∂schung</strong> (Art. 17 DSGVO)</li>
                <li><strong>Widerspruch</strong> (Art. 21 DSGVO)</li>
            </ul>

            <p>Kontakt: [Wird im Setup eingef√ºgt]</p>

            <p><small>Stand: November 2025</small></p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./leaflet/leaflet.js"></script>
    <script src="./js/app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Service Worker registrieren
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registriert:', registration.scope);
                        
                        // Update-Check
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ Neue Version verf√ºgbar!');
                                    // User benachrichtigen
                                    if (confirm('Neue Version verf√ºgbar! Neu laden?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker Fehler:', error);
                    });
            });
            
            // Reload bei neuem SW
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Zeige Install-Button im Header
            const installBtn = document.getElementById('installAppBtn');
            if (installBtn && !window.matchMedia('(display-mode: standalone)').matches) {
                installBtn.style.display = 'inline-block';
            }

            // Pr√ºfe ob bereits angezeigt wurde
            const hasSeenInstallPrompt = localStorage.getItem('hasSeenInstallPrompt');

            // Zeige Install-Prompt nur beim ersten Mal automatisch
            if (!hasSeenInstallPrompt) {
                setTimeout(() => {
                    const installPrompt = document.getElementById('installPrompt');
                    if (installPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                        installPrompt.style.display = 'block';
                    }
                }, 10000);
            }
        });

        // Funktion zum manuellen Anzeigen des Install-Prompts
        window.showInstallPrompt = function() {
            const installPrompt = document.getElementById('installPrompt');
            if (deferredPrompt && installPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                installPrompt.style.display = 'block';
            } else if (window.matchMedia('(display-mode: standalone)').matches) {
                alert('Die App ist bereits installiert!');
            } else {
                alert('Installation ist im Browser nicht verf√ºgbar. Bitte √∂ffnen Sie die Seite im Browser und versuchen Sie es erneut.');
            }
        };

        // Funktion zum Ausblenden des Install-Prompts mit Animation
        function hideInstallPrompt() {
            const installPrompt = document.getElementById('installPrompt');
            if (installPrompt) {
                installPrompt.classList.add('slide-out');
                setTimeout(() => {
                    installPrompt.style.display = 'none';
                    installPrompt.classList.remove('slide-out');
                }, 300);
            }
        }

        // Install-Button Handler
        document.getElementById('installButton')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Install outcome:', outcome);

                // Markiere als gesehen
                localStorage.setItem('hasSeenInstallPrompt', 'true');

                // Verstecke Popup mit Animation
                hideInstallPrompt();

                // Verstecke Header-Button nach Installation
                if (outcome === 'accepted') {
                    const installBtn = document.getElementById('installAppBtn');
                    if (installBtn) installBtn.style.display = 'none';
                }

                deferredPrompt = null;
            }
        });

        // Dismiss-Button Handler
        document.getElementById('dismissInstall')?.addEventListener('click', () => {
            // Markiere als gesehen
            localStorage.setItem('hasSeenInstallPrompt', 'true');
            hideInstallPrompt();
        });
        
        // Online/Offline Status
        window.addEventListener('online', () => {
            document.getElementById('offlineNotice').style.display = 'none';
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offlineNotice').style.display = 'block';
        });
        
        // Initial Status
        if (!navigator.onLine) {
            document.getElementById('offlineNotice').style.display = 'block';
        }
    </script>

    <!-- Back to Top Button Functionality -->
    <script>
        (function() {
            const backToTopButton = document.getElementById('backToTop');
            const scrollThreshold = 300;

            function toggleBackToTopButton() {
                if (window.pageYOffset > scrollThreshold || document.documentElement.scrollTop > scrollThreshold) {
                    backToTopButton.classList.add('visible');
                } else {
                    backToTopButton.classList.remove('visible');
                }
            }

            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            window.addEventListener('scroll', toggleBackToTopButton);
            backToTopButton.addEventListener('click', scrollToTop);

            toggleBackToTopButton();
        })();
    </script>
</body>
</html>
