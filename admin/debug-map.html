<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karten Debug</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .debug-box h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
        #testMap {
            height: 400px;
            width: 100%;
            border: 2px solid #cc0000;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Karten Debug</h1>

    <div class="debug-box">
        <h3>1. Leaflet geladen?</h3>
        <div id="leafletCheck">Pr√ºfe...</div>
    </div>

    <div class="debug-box">
        <h3>2. API-Daten laden</h3>
        <button onclick="loadHydrants()">Hydranten von API laden</button>
        <div id="apiResult"></div>
    </div>

    <div class="debug-box">
        <h3>3. Test-Karte</h3>
        <p>Wenn du eine Karte siehst, funktioniert Leaflet grunds√§tzlich:</p>
        <div id="testMap"></div>
        <div id="mapResult"></div>
    </div>

    <div class="debug-box">
        <h3>4. Icon-Test</h3>
        <div id="iconTest"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Leaflet Check
        function checkLeaflet() {
            const result = document.getElementById('leafletCheck');
            if (typeof L !== 'undefined') {
                result.innerHTML = '<span class="success">‚úì Leaflet ist geladen (Version: ' + L.version + ')</span>';
                initTestMap();
            } else {
                result.innerHTML = '<span class="error">‚úó Leaflet nicht geladen!</span>';
            }
        }

        // 2. API-Daten laden
        async function loadHydrants() {
            const result = document.getElementById('apiResult');
            result.innerHTML = '<p class="info">Lade...</p>';
            
            try {
                const response = await fetch('../api/hydrants.php', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const hydrants = data.data.hydrants || [];
                    result.innerHTML = `
                        <p class="success">‚úì ${hydrants.length} Hydranten geladen</p>
                        <pre>${JSON.stringify(hydrants.slice(0, 2), null, 2)}</pre>
                        <p>Erste 2 Hydranten zur Ansicht (von ${hydrants.length})</p>
                    `;
                    
                    // Versuche Marker zu setzen
                    if (window.testMap) {
                        testMarkers(hydrants);
                    }
                } else {
                    result.innerHTML = '<p class="error">‚úó Fehler: ' + data.error + '</p>';
                }
            } catch (error) {
                result.innerHTML = '<p class="error">‚úó Fehler: ' + error.message + '</p>';
            }
        }

        // 3. Test-Karte initialisieren
        function initTestMap() {
            const result = document.getElementById('mapResult');
            try {
                window.testMap = L.map('testMap').setView([50.000, 7.360], 14);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OSM'
                }).addTo(window.testMap);
                
                result.innerHTML = '<p class="success">‚úì Karte erfolgreich initialisiert</p>';
                
                // Test-Marker setzen
                const testMarker = L.marker([50.000, 7.360]).addTo(window.testMap);
                testMarker.bindPopup('Test-Marker - Wenn du das siehst, funktioniert die Karte!');
                
                result.innerHTML += '<p class="success">‚úì Test-Marker gesetzt</p>';
            } catch (error) {
                result.innerHTML = '<p class="error">‚úó Fehler beim Erstellen der Karte: ' + error.message + '</p>';
                console.error('Map Error:', error);
            }
        }

        // 4. Marker mit echten Daten
        function testMarkers(hydrants) {
            const result = document.getElementById('mapResult');
            try {
                hydrants.slice(0, 5).forEach(h => {
                    const marker = L.marker([h.lat, h.lng]).addTo(window.testMap);
                    marker.bindPopup(`<strong>${h.title}</strong><br>${h.type}`);
                });
                result.innerHTML += `<p class="success">‚úì ${Math.min(5, hydrants.length)} Marker gesetzt</p>`;
            } catch (error) {
                result.innerHTML += '<p class="error">‚úó Fehler beim Setzen der Marker: ' + error.message + '</p>';
                console.error('Marker Error:', error);
            }
        }

        // 5. Icon-Test
        function testIcons() {
            const result = document.getElementById('iconTest');
            const iconPaths = [
                '../markericon.png',
                '../markericon_gruen.png',
                '../markericon_blau.png',
                '../markericon_rot.png',
                '../markericon_aqua.png'
            ];
            
            let html = '<p>Teste Icon-Pfade:</p>';
            iconPaths.forEach(path => {
                html += `<div><img src="${path}" style="width:25px;height:41px;vertical-align:middle;"> ${path}</div>`;
            });
            result.innerHTML = html;
        }

        // Init
        setTimeout(() => {
            checkLeaflet();
            testIcons();
        }, 500);
    </script>
</body>
</html>
